apiVersion: apps/v1
kind: Deployment
metadata:
  name: rriv-api
  labels:
    app: rriv-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rriv-api
  template:
    metadata:
      labels:
        app: rriv-api
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "webapp"
        vault.hashicorp.com/auth-path: "auth/kubernetes-rriv"
        vault.hashicorp.com/agent-inject-secret-credentials.txt: "secret/data/dev-rriv-api-creds"
        vault.hashicorp.com/agent-inject-template-credentials: |
          {{ with secret "secret/data/dev-rriv-api-creds" }}
          export DATABASE_URL="{{ .Data.data.database_url }}"
          export KEYCLOAK_CLIENT_SECRET="{{ .Data.data.keycloack_client_secret }}"
          {{ end }}
    spec:
      serviceAccountName: internal-app
      imagePullSecrets:
        - name: registry-rriv
      containers:
        - name: rriv-api
          command: ["/bin/sh", "-c"]
          args:
            - |
                timeout=20
                elapsed=0
                while [ ! -f /vault/secrets/credentials ]; do
                  if [ $elapsed -ge $timeout ]; then
                    echo "Timeout waiting for Vault to inject secrets"
                    exit 1
                  fi
                  echo "Waiting for Vault to inject secrets..."
                  sleep 2
                  elapsed=$((elapsed + 2))
                done
                echo "Vault secrets injected"
                . /vault/secrets/credentials
                echo "starting service"
                #while :; do echo 'Hit CTRL+C'; sleep 1; done # go forever
                exec deno run --allow-read --allow-net --allow-env --allow-sys --allow-ffi src/server.ts
          image: registry.digitalocean.com/rriv/rriv-api:1.0.5
          ports:
            - containerPort: 3006
          env:
            - name: DATABASE_SCHEMA
              value: rriv
            - name: KEYCLOAK_CLIENT_ID
              value: rriv-api